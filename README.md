## Аналитика монетизации плитформы для решения задач
### Описание задачи
Сейчас, по сути, платформа бесплатная. В ней есть внутренняя валюта, но мало кто ее покупает. Смысл такой - за активность на платформе пользователи получают монеты, также они могут их купить за деньги. А потратить они их могут, чтобы открыть премиальные задачи, тесты, подсказки и решения.
У внутренней валюты есть несколько существенных недостатков:
- Ее сложно продавать - практически никакой рекламной стимуляции валюта не подвергается
- На нее сложно делать акции
- Большинство людей покупает маленькие пакеты монет (да и сами пакеты недорогие)
- Человек может единоразово купить монет и ему хватит надолго
  
Пока платформа молодая и находится на стадии роста, компания планирует внедрить стандартную подписочную модель.

Для определеня, что будет входить в подписку, мне поручено посчитать следующие основные метрики, которые помогут принять решение:
- Метрика n-day retention.
- Метрика rolling retention.
- Среднее и медианное число решаемых задач и тестов.
- Сколько монет в среднем списывает пользователь за весь срок жизни? Сколько монет ему начисляется? Какая дельта между этими двумя метриками?
- Распределение итогового баланса пользователей по перцентилям.
- % сессий, не сопровождающихся активностью.
- Метрика MAU.

### Исходные дынные
Данные для подключения к базе данных:
```
Хост: 95.163.241.236
Порт: 5432
База данных: simulative
Юзер: student
Пароль: qweasd963
```
[Структура таблиц](https://docs.google.com/document/d/1TwZXkZZVGD7fk-6wTeVoZykTGw7ovObWnEEvH2kLfxM/edit)

### Распределение числа решенных задач и тестов

Задача посчитать:

- сколько в среднем задач решает один пользователь (пусть даже неправильно, но хотя бы делает попытку)
- сколько в среднем тестов начинает проходить один пользователь (пусть даже не заканчивает)

Код для решения задачи:
```
-- объединяем таблицы codesubmit и coderun
with run_submit_uniuon as
	(
	select user_id, problem_id
	from codesubmit 
	union all
	select user_id, problem_id 
	from coderun
	),
-- считаем количество уникальных задач, которые решил каждый пользователь
cnt_problems as 
	(
	select user_id, count(distinct problem_id) cnt_problems -- считаем количество задач 
	from run_submit_uniuon
	group by user_id
	),
-- считаем количество уникальных тесов, которые решил каждый пользователь
cnt_tests as 
	(
	select t.user_id, count(distinct t.test_id) cnt_tests
	from teststart t 
	group by t.user_id
	)
-- формируем итоговую таблицу со средними значениями
select
-- средние значения
	round(avg(cnt_problems), 2) problems_avg,
	round(avg(cnt_tests), 2) tests_avg,
-- медианные значения
	percentile_cont(0.5) within group(order by cnt_problems problems_median,
	percentile_cont(0.5) within group(order by cnt_tests tests_median
from cnt_problems, cnt_tests
```


